<!DOCTYPE html>
<html>
<style type="text/css">
    #header:after {
        content: 'off';
    }

    #header.capslock:after {
        content: 'on';
        background: red;
    }
</style>
<script>
    function isPlatform(searchTerm) {
        const platform = navigator.platform;
        return platform.includes(searchTerm);
    }
    function getCurrentOs() {
        if (isPlatform("Mac")) {
            return "Mac";
        }
        if (isPlatform("Linux")) {
            return "Linux";
        }
        if (isPlatform("Win")) {
            return "Windows";
        }
        return "Unknown";
    }
    let previousCapsState = false;
    let capsState = false;
    const os = getCurrentOs();

    addEventListener("DOMContentLoaded", () => {
        const pre = document.createElement("pre");
        pre.innerText = `os: ${os}\nplatform: ${navigator.platform}\nuserAgent: ${navigator.userAgent}\n`;
        document.body.append(pre);
        logs = document.getElementById("logs");
    })
    
    let onCapsChangeCallback;
    function shouldCallCallback() {
        let callCallback = previousCapsState !== capsState;
        previousCapsState = capsState;
        return callCallback;
    }
    function getCapsLockModifierState(event) {
        return event.getModifierState("CapsLock");
    }
    document.addEventListener("mousedown", (event) => {
        capsState = getCapsLockModifierState(event);
        if (shouldCallCallback()) {
            onCapsChangeCallback(capsState);
        }
    });
    document.addEventListener("keyup", (event) => {
        if (os === "Mac") {
            if (event.key === "CapsLock") {
                capsState = false;
            }
            else {
                if (navigator.maxTouchPoints <= 1) {
                    capsState = getCapsLockModifierState(event);
                }
            }
        }
        else if (os === "Windows") {
            capsState = getCapsLockModifierState(event);
        }
        else if (event.key !== "CapsLock") {
            capsState = getCapsLockModifierState(event);
        }
        if (shouldCallCallback()) {
            onCapsChangeCallback(capsState);
        }
    });
    document.addEventListener("keydown", (event) => {
        if (os === "Mac") {
            if (event.key === "CapsLock") {
                capsState = true;
                if (shouldCallCallback()) {
                    onCapsChangeCallback(capsState);
                }
            }
        }
        else if (os === "Linux") {
            if (event.key === "CapsLock") {
                capsState = !getCapsLockModifierState(event);
            }
        }
    });
    function isCapsLockOn() {
        return capsState;
    }
    function onCapsLockChange(callback) {
        onCapsChangeCallback = callback;
    }

    onCapsLockChange((caps) => {
        console.log("capslock is ", caps ? "on" : "off");
        logs.innerText += `\ncapslock is ${caps ? "on" : "off"}`;

        if (caps) {
            document.getElementById('header').classList = ['capslock'];
        } else {
            document.getElementById('header').classList = [];
        }
    })

</script>

<body>
    <h1 id="header">Caps-Lock is </h1>
    type some text or toggle caps lock...
    <div id="text"></div>

    <textarea></textarea>
    <br />
    <br />
    <h2>logs</h2>
    <pre id="logs"></pre>
</body>

</html>
